# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: "Release"
on:
  release:
    types: [ published ]
permissions: { }
env:
  GRAILS_PUBLISH_RELEASE: 'true'
jobs:
  publish:
    name: "Stage Jar Files"
    permissions:
      contents: write # to stage distributions to the GitHub release page
      issues: write # to modify milestones
    runs-on: ubuntu-24.04
    outputs:
      commit_sha: ${{ steps.commit_sha.outputs.value }}
      release_version: ${{ steps.release_version.outputs.value }}
    steps:
      - name: "üåê Output Agent IP" # in the event RAO blocks this agent, this can be used to debug it
        run: curl -s https://api.ipify.org
      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # This should not be needed as ${{ github.token }} is the default, but there have been issues with it.
      - name: "üìÖ Store common build date" # to ensure a reproducible build
        run: echo "SOURCE_DATE_EPOCH=$(git log -1 --pretty=%ct)" >> "$GITHUB_ENV"
      - name: "üìÖ Ensure source files use common date"
        run: find . -depth \( -type f -o -type d \) -exec touch -d "@${SOURCE_DATE_EPOCH}" {} +
      - name: "üîê Set up GPG for signing"
        run: |
          echo "${{ secrets.GRAILS_GPG_KEY }}" | gpg --batch --import
          gpg --list-keys
      - name: "‚òïÔ∏è Setup JDK"
        uses: actions/setup-java@v5
        with:
          distribution: liberica
          java-version: 17.0.14 # this must be a specific version for reproducible builds
      - name: "üêò Setup Gradle"
        uses: gradle/actions/setup-gradle@v5
        with:
          develocity-access-key: ${{ secrets.GRAILS_DEVELOCITY_ACCESS_KEY }}
      - name: "üìù Store the current release version"
        id: release_version
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
        run: echo "value=${TAG_NAME#v}" >> $GITHUB_OUTPUT
      - name: "‚öôÔ∏è Run pre-release"
        uses: apache/grails-github-actions/pre-release@asf
        env:
          RELEASE_VERSION: ${{ steps.release_version.outputs.value }}
      - name: "üìù Fetch new sha for the release tag after pre-prelease commit"
        id: commit_sha
        env:
          REPO: ${{ github.repository }}
          TAG: ${{ github.event.release.tag_name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ref_json=$(gh api "repos/$REPO/git/ref/tags/$TAG")
          type=$(jq -r '.object.type' <<<"$ref_json")
          sha=$(jq -r '.object.sha'  <<<"$ref_json")
          if [ "$type" = "tag" ]; then
            sha=$(gh api "repos/$REPO/git/tags/$sha" --jq '.object.sha')
          fi
          echo "Found commit sha: $sha"
          echo "value=$sha" >> $GITHUB_OUTPUT
      - name: "üß© Run Assemble"
        run: >
          ./gradlew assemble
      - name: "üì¶ Generate docs"
        run: >
          ./gradlew grails-publish:groovydoc
      - name: "‚ú® Create Staging Repository"
        env:
          NEXUS_PUBLISH_USERNAME: ${{ secrets.NEXUS_STAGE_DEPLOYER_USER }}
          NEXUS_PUBLISH_PASSWORD: ${{ secrets.NEXUS_STAGE_DEPLOYER_PW }}
          NEXUS_PUBLISH_URL: ${{ vars.STAGING_URL }}
          NEXUS_PUBLISH_STAGING_PROFILE_ID: ${{ secrets.STAGING_PROFILE_ID }}
          NEXUS_PUBLISH_DESCRIPTION: '${{ github.event.repository.name }}:${{ steps.release_version.outputs.value }}'
          SIGNING_KEY: ${{ secrets.GPG_KEY_ID }}
        run: ./gradlew initializeSonatypeStagingRepository
      - name: "üì§ Publish"
        env:
          NEXUS_PUBLISH_USERNAME: ${{ secrets.NEXUS_STAGE_DEPLOYER_USER }}
          NEXUS_PUBLISH_PASSWORD: ${{ secrets.NEXUS_STAGE_DEPLOYER_PW }}
          NEXUS_PUBLISH_URL: ${{ vars.STAGING_URL }}
          NEXUS_PUBLISH_STAGING_PROFILE_ID: ${{ secrets.STAGING_PROFILE_ID }}
          NEXUS_PUBLISH_DESCRIPTION: '${{ github.event.repository.name }}:${{ steps.release_version.outputs.value }}'
          SIGNING_KEY: ${{ secrets.GPG_KEY_ID }}
        run: >
          ./gradlew findSonatypeStagingRepository 
          publishToSonatype 
          aggregateChecksums
          aggregatePublishedArtifacts
          -x initializeSonatypeStagingRepository
      - name: "‚úÖ Close Staging Repository"
        env:
          NEXUS_PUBLISH_USERNAME: ${{ secrets.NEXUS_STAGE_DEPLOYER_USER }}
          NEXUS_PUBLISH_PASSWORD: ${{ secrets.NEXUS_STAGE_DEPLOYER_PW }}
          NEXUS_PUBLISH_URL: ${{ vars.STAGING_URL }}
          NEXUS_PUBLISH_STAGING_PROFILE_ID: ${{ secrets.STAGING_PROFILE_ID }}
          NEXUS_PUBLISH_DESCRIPTION: '${{ github.event.repository.name }}:${{ steps.release_version.outputs.value }}'
          SIGNING_KEY: ${{ secrets.GPG_KEY_ID }}
        run: >
          ./gradlew findSonatypeStagingRepository 
          closeSonatypeStagingRepository
          -x initializeSonatypeStagingRepository
      - name: "üìÖ Generate build date file"
        run: echo "$SOURCE_DATE_EPOCH" >> build/BUILD_DATE.txt
      - name: "üì§ Upload build date, checksums and published artifacts files"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            build/BUILD_DATE.txt
            build/CHECKSUMS.txt
            build/PUBLISHED_ARTIFACTS.txt
  source:
    name: "Create Source Distribution"
    needs: publish
    permissions:
      contents: write
    runs-on: ubuntu-24.04
    steps:
      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # This should not be needed as ${{ github.token }} is the default, but there have been issues with it.
          path: 'grails-publish'
      - name: "üóëÔ∏è Remove unnecessary files"
        run: |
          rm -f \
          grails-publish/gradle/wrapper/gradle-wrapper.jar \
          grails-publish/gradle/wrapper/gradle-wrapper.properties \
          grails-publish/gradlew.bat \
          grails-publish/gradlew
      - name: "üì• Download CHECKSUMS.txt and rename to CHECKSUMS"
        working-directory: 'grails-publish'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_url=$(gh release view ${{ github.event.release.tag_name }} --json assets --repo ${{ github.repository }} --jq '.assets[] | select(.name == "CHECKSUMS.txt") | .url')
          curl -f -L -H "Authorization: token $GH_TOKEN" -o CHECKSUMS "$release_url"
      - name: "üì• Download PUBLISHED_ARTIFACTS.txt and rename to PUBLISHED_ARTIFACTS"
        working-directory: 'grails-publish'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_url=$(gh release view ${{ github.event.release.tag_name }} --json assets --repo ${{ github.repository }} --jq '.assets[] | select(.name == "PUBLISHED_ARTIFACTS.txt") | .url')
          curl -f -L -H "Authorization: token $GH_TOKEN" -o PUBLISHED_ARTIFACTS "$release_url"
      - name: "üì• Download BUILD_DATE.txt and rename to BUILD_DATE"
        working-directory: 'grails-publish'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_url=$(gh release view ${{ github.event.release.tag_name }} --json assets --repo ${{ github.repository }} --jq '.assets[] | select(.name == "BUILD_DATE.txt") | .url')
          curl -f -L -H "Authorization: token $GH_TOKEN" -o BUILD_DATE "$release_url"
      - name: "üìÖ Ensure source files use common date"
        run: |
          SOURCE_DATE_EPOCH=$(cat grails-publish/BUILD_DATE)
          find . -depth \( -type f -o -type d \) -exec touch -d "@${SOURCE_DATE_EPOCH}" {} +
      - name: "üì¶ Create source distribution ZIP"
        run: |
          zip -r \
          "apache-grails-publish-${{ needs.publish.outputs.release_version }}-src.zip" \
          grails-publish \
          -x 'grails-publish/.git/*' \
          -x 'grails-publish/.github/*'
      - name: 'üîê Set up GPG for signing artifacts'
        run: |
          echo "${{ secrets.GRAILS_GPG_KEY }}" | gpg --batch --import
          gpg --list-keys
      - name: "üîè Sign source distribution ZIP"
        run: |
          gpg \
          --default-key "${{ secrets.GPG_KEY_ID }}" \
          --batch \
          --yes \
          --pinentry-mode loopback \
          --armor \
          --detach-sign apache-grails-publish-${{ needs.publish.outputs.release_version }}-src.zip
      - name: "üì¶ Create source distribution checksum"
        run: |
          sha512sum "apache-grails-publish-${{ needs.publish.outputs.release_version }}-src.zip" \
          > "apache-grails-publish-${{ needs.publish.outputs.release_version }}-src.zip.sha512"
      - name: "üöÄ Upload ZIP and Signature to GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            apache-grails-publish-${{ needs.publish.outputs.release_version }}-src.zip
            apache-grails-publish-${{ needs.publish.outputs.release_version }}-src.zip.asc
            apache-grails-publish-${{ needs.publish.outputs.release_version }}-src.zip.sha512
      - name: "üóëÔ∏è Remove CHECKSUMS.txt asset from release"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          gh release delete-asset \
          ${{ github.event.release.tag_name }} \
          CHECKSUMS.txt \
          --repo ${{ github.repository }} \
          --yes
      - name: "üóëÔ∏è Remove BUILD_DATE.txt asset from release"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          gh release delete-asset \
          ${{ github.event.release.tag_name }} \
          BUILD_DATE.txt \
          --repo ${{ github.repository }} \
          --yes
      - name: "üóëÔ∏è Remove PUBLISHED_ARTIFACTS.txt asset from release"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          gh release delete-asset \
          ${{ github.event.release.tag_name }} \
          PUBLISHED_ARTIFACTS.txt \
          --repo ${{ github.repository }} \
          --yes
  upload:
    name: "Upload Source Distribution"
    needs: [ publish, source ]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    env:
      SVN_USERNAME: ${{ secrets.SVC_DIST_GRAILS_USERNAME }}
      SVN_PASSWORD: ${{ secrets.SVC_DIST_GRAILS_PASSWORD }}
    steps:
      - name: "üåê Output Agent IP" # in the event RAO blocks this agent, this can be used to debug it
        run: curl -s https://api.ipify.org
      - name: "‚öôÔ∏è Setup SVN and Tools"
        run: sudo apt-get install -y subversion subversion-tools tree gettext-base
      - name: "üëÄ Ensure grails dev folder exists"
        run: |
          set -e
          if svn ls https://dist.apache.org/repos/dist/dev/grails --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --non-interactive; then
            echo "Dev Folder 'grails' already exists ‚Äî skipping creation"
          else
            echo "Dev Folder 'grails' does not exist, creating"
            svnmucc --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --non-interactive \
              mkdir https://dist.apache.org/repos/dist/dev/grails \
              -m "Create 'grails' dev folder"
          fi
      - name: "üëÄ Ensure grails publish folder exists"
        run: |
          set -e
          if svn ls https://dist.apache.org/repos/dist/dev/grails/grails-publish --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --non-interactive; then
            echo "Dev Folder 'grails/grails-publish' already exists ‚Äî skipping creation"
          else
            echo "Dev Folder 'grails/grails-publish' does not exist, creating"
            svnmucc --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --non-interactive \
              mkdir https://dist.apache.org/repos/dist/dev/grails/grails-publish \
              -m "Create 'grails-publish' dev folder"
          fi
      - name: "üì• Checkout dev repo"
        run: |
          svn checkout --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --non-interactive https://dist.apache.org/repos/dist/dev/grails/grails-publish dev-repo
      - name: "üóëÔ∏è Remove existing dev version"
        run: |
          export VERSION="${{ needs.publish.outputs.release_version }}"
          cd dev-repo
          if [ -d "$VERSION" ]; then
            svn delete "$VERSION"
            svn commit -m "Remove grails-publish dev version $VERSION" --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --non-interactive
          else
            echo "No existing dev version $VERSION to remove"
          fi
      - name: "üì• Fetch source distributions"
        run: |
          export TAG="${{ github.event.release.tag_name }}"
          export VERSION="${{ needs.publish.outputs.release_version }}"
          cd dev-repo
          mkdir -p $VERSION/sources          
          cd $VERSION/sources
          curl -f -LO https://github.com/${{ github.repository }}/releases/download/$TAG/apache-grails-publish-$VERSION-src.zip
          curl -f -LO https://github.com/${{ github.repository }}/releases/download/$TAG/apache-grails-publish-$VERSION-src.zip.sha512
          curl -f -LO https://github.com/${{ github.repository }}/releases/download/$TAG/apache-grails-publish-$VERSION-src.zip.asc
          echo "Downloaded the following files:"
          ls -l
      - name: "Upload distributions"
        run: |
          export VERSION="${{ needs.publish.outputs.release_version }}"
          cd dev-repo
          echo "Adding the following files to SVN:"
          tree
          svn add $VERSION --force
          svn commit -m "Upload grails distribution files for $VERSION" --username "$SVN_USERNAME" --password "$SVN_PASSWORD" --non-interactive
          pwd
      - name: "üíæ Store Distribution SVN revision in a file"
        run: |
          export VERSION="${{ needs.publish.outputs.release_version }}"
          cd dev-repo
          svn info $VERSION > "DIST_SVN_REVISION.txt"
      - name: "üì§ Upload the Distribution SVN revision file"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: dev-repo/DIST_SVN_REVISION.txt
      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # This should not be needed as ${{ github.token }} is the default, but there have been issues with it.
          path: 'grails-publish'
      - name: "üìß Print Grails Vote Email"
        env:
          VERSION: ${{ needs.publish.outputs.release_version }}
          VERSION_COMMIT_ID: ${{ needs.publish.outputs.commit_sha }}
        run: |
          export DIST_SVN_REVISION=$(awk '/Last Changed Rev:/ {print $4}' dev-repo/DIST_SVN_REVISION.txt)
          echo "::group::Grails PMC Vote Email"
          echo ""
          echo "TO:"
          echo "*************************************************"
          echo "dev@grails.apache.org"
          echo "*************************************************"
          echo ""
          echo "Subject:"
          echo "*************************************************"
          echo "[VOTE] Release Apache Grails - Gradle Plugin - Grails Publish ${VERSION}"
          echo "*************************************************"
          echo ""
          echo "Body:"
          echo "*************************************************"
          cat grails-publish/.github/vote_templates/staged.txt | envsubst
          echo "*************************************************"
          echo "::endgroup::"
  release:
    environment: release
    name: 'VOTE SUCCEEDED - Release Artifacts'
    needs: [ publish, source, upload ]
    runs-on: ubuntu-24.04
    steps:
      - name: "Output Agent IP" # in the event RAO blocks this agent, this can be used to debug it
        run: curl -s https://api.ipify.org
      - name: "Setup SVN and Tools"
        run: sudo apt-get install -y subversion subversion-tools tree gettext-base
      - name: "üó≥ Grails PMC Vote Confirmation - MANUAL"
        run: |
          echo "::group::Manual Confirmation"
          echo "üîé This step is a placeholder that the vote confirmation on dev@grails.apache.org completed successfully."
          echo "::endgroup::"
      - name: "üöÄ Release JAR files - MANUAL"
        run: |
          echo "::group::Manual Jar Promotion"
          echo "Run .github/scripts/releaseJarFiles.sh '${{ github.event.release.tag_name }}' '${{ github.event.repository.name }}:${{ needs.publish.outputs.release_version }}' <ASF_USER>"
          echo "::endgroup::"
      - name: "üöÄ Release distribution artifacts - MANUAL"
        run: |
          echo "::group::Manual ASF Artifact Promotion"
          echo "Run github/scripts/releaseDistributions.sh '${{ github.event.release.tag_name }}' <ASF_USER>"
          echo "::endgroup::"
      - name: "‚úÖ Update ASF Reporter - MANUAL"
        run: |
          echo "::group::Manual ASF Reporter Update"
          TODAY=$(date +"%Y-%m-%d")
          echo "Check email from no-reply@reporter.apache.org & update https://reporter.apache.org/addrelease.html?grails to add GRAILS-PUBLISH-${{ needs.publish.outputs.release_version }} as complete as of ${TODAY}"
          echo "::endgroup::"
  docs:
    environment: docs
    name: "VOTE SUCCEEDED - Publish Documentation"
    needs: [ publish, source, upload ] # TODO Once we have confirmed release won't fail, add it as a dependency here
    runs-on: ubuntu-24.04
    permissions:
      contents: write # required gh-pages update
    steps:
      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # This should not be needed as ${{ github.token }} is the default, but there have been issues with it.
      - name: "üìÖ Ensure Common Build Date" # to ensure a reproducible build
        run: echo "SOURCE_DATE_EPOCH=$(git log -1 --pretty=%ct)" >> "$GITHUB_ENV"
      - name: "‚òïÔ∏è Setup JDK"
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: liberica
      - name: "üêò Setup Gradle"
        uses: gradle/actions/setup-gradle@v5
        with:
          develocity-access-key: ${{ secrets.GRAILS_DEVELOCITY_ACCESS_KEY }}
      - name: "üìñ Generate Documentation"
        run: >
          ./gradlew grails-publish:groovydoc
      - name: "üöÄ Publish to Github Pages"
        uses: apache/grails-github-actions/deploy-github-pages@asf
        env:
          GRADLE_PUBLISH_RELEASE: 'true'
          SOURCE_FOLDER: plugin/build/docs/api
          VERSION: ${{ needs.publish.outputs.release_version }}
  close:
    name: "VOTE SUCCEEDED - Close Release"
    environment: release
    needs: [ publish, source, upload, docs, release ]
    runs-on: ubuntu-24.04
    permissions:
      contents: write # required for gradle.properties revert
      issues: write # required for milestone closing
      pull-requests: write # to open PR
      actions: write # in case there are pending changes to release.yml in the target branch
    steps:
      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # This should not be needed as ${{ github.token }} is the default, but there have been issues with it.
      - name: "‚öôÔ∏è Run post-release"
        uses: apache/grails-github-actions/post-release@asf
      - name: 'üåé Create Blog Post - MANUAL'
        run: |
          echo "::group::Blog Post Creation - MANUAL"
          echo "Publish a blog post on https://grails.apache.org/blog/ about the new release ${{ needs.publish.outputs.release_version }} using the repo https://github.com/apache/grails-static-website"
          echo "::endgroup::"
      - name: '‚úâÔ∏è Announcement Email'
        env:
          VERSION: ${{ needs.publish.outputs.release_version }}
          PREVIOUS_VERSION: 'TODO_PREVIOUS_VERSION'
        run: |
          echo "::group::Announcement Email"
          echo ""
          echo "TO:"
          echo "*************************************************"
          echo "announce@apache.org, dev@grails.apache.org, users@grails.apache.org"
          echo "*************************************************"
          echo ""
          echo "Subject:"
          echo "*************************************************"
          echo "[ANNOUNCE] Apache Grails - Gradle Plugin - Grails Publish ${VERSION}"
          echo "*************************************************"
          echo ""
          echo "Body:"
          echo "*************************************************"
          cat .github/vote_templates/announce.txt | envsubst
          echo "*************************************************"
          echo "::endgroup::"
