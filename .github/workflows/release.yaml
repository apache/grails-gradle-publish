# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: "Release"
on:
  release:
    types: [ published ]
permissions: { }
env:
  DIST_NAME: apache-grails-publish
  GRAILS_PUBLISH_RELEASE: 'true'
  JAVA_DISTRIBUTION: liberica
  JAVA_VERSION: 17.0.17 # this must be a specific version for reproducible builds, keep it synced with .sdkmanrc and verification container
  PROJECT_DESC: >
    The Grails Publish Gradle Plugin is a tool that simplifies the process of publishing
    Grails-related artifacts to various repository types - making it easier for developers
    to share their work with the community.
  PROJECT_NAME: Grails Publish Gradle Plugin
  REPO_NAME: ${{ github.event.repository.name }}
  REPO_SLUG: ${{ github.repository }}
  SVN_FOLDER: grails-publish
  SVN_PROJECT: grails
  TAG: ${{ github.event.release.tag_name }}
  TARGET_BRANCH: ${{ github.event.release.target_commitish }}
  VERSION: will be computed in each job
jobs:
  publish:
    name: "Stage Jar Files"
    permissions:
      contents: write # to stage distributions to the GitHub release page
      issues: write # to modify milestones
    runs-on: ubuntu-24.04
    steps:
      - name: "üìù Establish release version"
        run: echo "VERSION=${TAG#v}" >> "$GITHUB_ENV"
      - name: "üåê Output Agent IP" # in the event RAO blocks this agent, this can be used to debug it
        run: curl -s https://api.ipify.org
      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          ref: ${{ env.TAG }}
          token: ${{ secrets.GITHUB_TOKEN }} # This should not be needed as ${{ github.token }} is the default, but there have been issues with it.
      - name: "üìÖ Store common build date" # to ensure a reproducible build
        run: echo "SOURCE_DATE_EPOCH=$(git log -1 --pretty=%ct)" >> "$GITHUB_ENV"
      - name: "üìÖ Ensure source files use common date"
        run: find . -depth \( -type f -o -type d \) -exec touch -d "@${SOURCE_DATE_EPOCH}" {} +
      - name: "üîê Set up GPG for signing" # Use env var to not expose the key
        env:
          GPG_KEY: ${{ secrets.GRAILS_GPG_KEY }}
        run: |
          echo "${GPG_KEY}" | gpg --batch --import
          gpg --list-keys
      - name: "‚òïÔ∏è Setup JDK"
        uses: actions/setup-java@v5
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
      - name: "üêò Setup Gradle"
        uses: gradle/actions/setup-gradle@v5
        with:
          develocity-access-key: ${{ secrets.GRAILS_DEVELOCITY_ACCESS_KEY }}
      - name: "‚öôÔ∏è Run pre-release"
        uses: apache/grails-github-actions/pre-release@asf
        env:
          RELEASE_VERSION: ${{ env.VERSION }}
      - name: "üß© Run Assemble"
        run: ./gradlew assemble
      - name: "üì¶ Generate docs"
        run: ./gradlew grails-publish:groovydoc
      - name: "‚ú® Create Staging Repository"
        env:
          NEXUS_PUBLISH_USERNAME: ${{ secrets.NEXUS_STAGE_DEPLOYER_USER }}
          NEXUS_PUBLISH_PASSWORD: ${{ secrets.NEXUS_STAGE_DEPLOYER_PW }}
          NEXUS_PUBLISH_URL: ${{ vars.STAGING_URL }}
          NEXUS_PUBLISH_STAGING_PROFILE_ID: ${{ secrets.STAGING_PROFILE_ID }}
          NEXUS_PUBLISH_DESCRIPTION: '${{ env.REPO_NAME }}:${{ env.VERSION }}'
        run: ./gradlew initializeSonatypeStagingRepository
      - name: "üì§ Publish to Staging Repository"
        env:
          NEXUS_PUBLISH_USERNAME: ${{ secrets.NEXUS_STAGE_DEPLOYER_USER }}
          NEXUS_PUBLISH_PASSWORD: ${{ secrets.NEXUS_STAGE_DEPLOYER_PW }}
          NEXUS_PUBLISH_URL: ${{ vars.STAGING_URL }}
          NEXUS_PUBLISH_STAGING_PROFILE_ID: ${{ secrets.STAGING_PROFILE_ID }}
          NEXUS_PUBLISH_DESCRIPTION: '${{ env.REPO_NAME }}:${{ env.VERSION }}'
          SIGNING_KEY: ${{ secrets.GPG_KEY_ID }}
        run: >
          ./gradlew
          -x initializeSonatypeStagingRepository
          findSonatypeStagingRepository
          publishToSonatype
          aggregateChecksums
          aggregatePublishedArtifacts
      - name: "‚úÖ Close Staging Repository"
        env:
          NEXUS_PUBLISH_USERNAME: ${{ secrets.NEXUS_STAGE_DEPLOYER_USER }}
          NEXUS_PUBLISH_PASSWORD: ${{ secrets.NEXUS_STAGE_DEPLOYER_PW }}
          NEXUS_PUBLISH_URL: ${{ vars.STAGING_URL }}
          NEXUS_PUBLISH_STAGING_PROFILE_ID: ${{ secrets.STAGING_PROFILE_ID }}
          NEXUS_PUBLISH_DESCRIPTION: '${{ env.REPO_NAME }}:${{ env.VERSION }}'
        run: >
          ./gradlew
          -x initializeSonatypeStagingRepository
          findSonatypeStagingRepository 
          closeSonatypeStagingRepository
      - name: "üìÖ Generate build date file"
        run: echo "$SOURCE_DATE_EPOCH" >> build/BUILD_DATE.txt
      - name: "üì§ Upload build date, checksums and published artifacts files"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: |
            build/BUILD_DATE.txt
            build/CHECKSUMS.txt
            build/PUBLISHED_ARTIFACTS.txt
  source:
    name: "Create Source Distribution"
    needs: publish
    permissions:
      contents: write
    runs-on: ubuntu-24.04
    steps:
      - name: "üìù Establish release version"
        run: echo "VERSION=${TAG#v}" >> "$GITHUB_ENV"
      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          path: grails-publish
          ref: ${{ env.TAG }}
          token: ${{ secrets.GITHUB_TOKEN }} # This should not be needed as ${{ github.token }} is the default, but there have been issues with it.
      - name: "üóëÔ∏è Remove unnecessary files"
        run: |
          rm -f grails-publish/gradle/wrapper/gradle-wrapper.jar
          rm -f grails-publish/gradle/wrapper/gradle-wrapper.properties
          rm -f grails-publish/gradlew.bat
          rm -f grails-publish/gradlew
      - name: "üì• Download CHECKSUMS.txt and rename to CHECKSUMS"
        working-directory: grails-publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_url=$(gh release view ${TAG} --json assets --repo ${REPO_SLUG} --jq '.assets[] | select(.name == "CHECKSUMS.txt") | .url')
          curl -f -L -H "Authorization: token $GH_TOKEN" -o CHECKSUMS "$release_url"
      - name: "üì• Download PUBLISHED_ARTIFACTS.txt and rename to PUBLISHED_ARTIFACTS"
        working-directory: grails-publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_url=$(gh release view ${TAG} --json assets --repo ${REPO_SLUG} --jq '.assets[] | select(.name == "PUBLISHED_ARTIFACTS.txt") | .url')
          curl -f -L -H "Authorization: token $GH_TOKEN" -o PUBLISHED_ARTIFACTS "$release_url"
      - name: "üì• Download BUILD_DATE.txt and rename to BUILD_DATE"
        working-directory: grails-publish
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          release_url=$(gh release view ${TAG} --json assets --repo ${REPO_SLUG} --jq '.assets[] | select(.name == "BUILD_DATE.txt") | .url')
          curl -f -L -H "Authorization: token $GH_TOKEN" -o BUILD_DATE "$release_url"
      - name: "üìÖ Ensure source files use common date"
        run: |
          SOURCE_DATE_EPOCH=$(cat grails-publish/BUILD_DATE)
          find . -depth \( -type f -o -type d \) -exec touch -d "@${SOURCE_DATE_EPOCH}" {} +
      - name: "üì¶ Create source distribution ZIP"
        run: >
          zip -r
          ${DIST_NAME}-${VERSION}-src.zip
          grails-publish
          -x 'grails-publish/.git/*'
          -x 'grails-publish/.github/*'
      - name: 'üîê Set up GPG for signing artifacts' # use env var to not expose the key
        env:
          GPG_KEY: ${{ secrets.GRAILS_GPG_KEY }}
        run: |
          echo "${GPG_KEY}" | gpg --batch --import
          gpg --list-keys
      - name: "üîè Sign source distribution ZIP"
        run: >
          gpg
          --default-key "${{ secrets.GPG_KEY_ID }}"
          --batch
          --yes
          --pinentry-mode loopback
          --armor
          --detach-sign
          ${DIST_NAME}-${VERSION}-src.zip
      - name: "üì¶ Create source distribution checksum"
        run: sha512sum ${DIST_NAME}-${VERSION}-src.zip > ${DIST_NAME}-${VERSION}-src.zip.sha512
      - name: "üöÄ Upload ZIP and Signature to GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: |
            ${{ env.DIST_NAME }}-${{ env.VERSION }}-src.zip
            ${{ env.DIST_NAME }}-${{ env.VERSION }}-src.zip.asc
            ${{ env.DIST_NAME }}-${{ env.VERSION }}-src.zip.sha512
      - name: "üóëÔ∏è Remove CHECKSUMS.txt asset from release"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          gh release delete-asset \
          ${TAG} \
          CHECKSUMS.txt \
          --repo ${REPO_SLUG} \
          --yes
      - name: "üóëÔ∏è Remove BUILD_DATE.txt asset from release"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          gh release delete-asset \
          ${TAG} \
          BUILD_DATE.txt \
          --repo ${REPO_SLUG} \
          --yes
      - name: "üóëÔ∏è Remove PUBLISHED_ARTIFACTS.txt asset from release"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          gh release delete-asset \
          ${TAG} \
          PUBLISHED_ARTIFACTS.txt \
          --repo ${REPO_SLUG} \
          --yes
  upload:
    name: "Upload Source Distribution to dist.apache.org"
    needs: [ publish, source ]
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    env:
      SVN_USERNAME: ${{ secrets.SVC_DIST_GRAILS_USERNAME }}
      SVN_PASSWORD: ${{ secrets.SVC_DIST_GRAILS_PASSWORD }}
    steps:
      - name: "üìù Establish release version"
        run: echo "VERSION=${TAG#v}" >> "$GITHUB_ENV"
      - name: "üõ†Ô∏è Install tools"
        run: sudo apt-get install -y subversion subversion-tools tree gettext-base
      - name: "üëÄ Ensure dev/${{ env.SVN_PROJECT }} folder exists"
        run: |
          set -e
          if svn ls https://dist.apache.org/repos/dist/dev/${SVN_PROJECT} --username "${SVN_USERNAME}" --password "${SVN_PASSWORD}" --non-interactive; then
            echo "Dev Folder [${SVN_PROJECT}] already exists ‚Äî skipping creation"
          else
            echo "Dev Folder [${SVN_PROJECT}] does not exist, creating"
            svnmucc --username "${SVN_USERNAME}" --password "${SVN_PASSWORD}" --non-interactive \
              mkdir https://dist.apache.org/repos/dist/dev/${SVN_PROJECT} \
              -m "Create '${SVN_PROJECT}' dev folder"
          fi
      - name: "üëÄ Ensure dev/${{ env.SVN_PROJECT }}/${{ env.SVN_FOLDER }} folder exists"
        run: |
          set -e
          if svn ls https://dist.apache.org/repos/dist/dev/${SVN_PROJECT}/${SVN_FOLDER} --username "${SVN_USERNAME}" --password "${SVN_PASSWORD}" --non-interactive; then
            echo "Dev Folder [${SVN_PROJECT}/${SVN_FOLDER}] already exists ‚Äî skipping creation"
          else
            echo "Dev Folder [${SVN_PROJECT}/${SVN_FOLDER}] does not exist, creating"
            svnmucc --username "${SVN_USERNAME}" --password "${SVN_PASSWORD}" --non-interactive \
              mkdir https://dist.apache.org/repos/dist/dev/${SVN_PROJECT}/${SVN_FOLDER} \
              -m "Create '${SVN_PROJECT}/${SVN_FOLDER}' dev folder"
          fi
      - name: "üì• Checkout dev repo"
        run: |
          svn checkout --username "${SVN_USERNAME}" --password "${SVN_PASSWORD}" --non-interactive "https://dist.apache.org/repos/dist/dev/${SVN_PROJECT}/${SVN_FOLDER}" dev-repo
      - name: "üóëÔ∏è Remove existing dev version"
        run: |
          cd dev-repo
          if [ -d "${VERSION}" ]; then
            svn delete "${VERSION}"
            svn commit -m "Remove ${SVN_PROJECT} ${SVN_FOLDER} dev version ${VERSION}" --username "${SVN_USERNAME}" --password "${SVN_PASSWORD}" --non-interactive
          else
            echo "No existing dev version ${VERSION} to remove"
          fi
      - name: "üì• Fetch source distributions"
        run: |
          cd dev-repo
          mkdir -p ${VERSION}/sources          
          cd ${VERSION}/sources
          curl -f -LO https://github.com/${REPO_SLUG}/releases/download/${TAG}/${DIST_NAME}-${VERSION}-src.zip
          curl -f -LO https://github.com/${REPO_SLUG}/releases/download/${TAG}/${DIST_NAME}-${VERSION}-src.zip.sha512
          curl -f -LO https://github.com/${REPO_SLUG}/releases/download/${TAG}/${DIST_NAME}-${VERSION}-src.zip.asc
          echo "Downloaded the following files:"
          ls -l
      - name: "üöÄ Upload distributions"
        run: |
          cd dev-repo
          echo "Adding the following files to SVN:"
          tree
          svn add ${VERSION} --force
          svn commit -m "Upload ${PROJECT_NAME} distribution files for ${VERSION}" --username "${SVN_USERNAME}" --password "${SVN_PASSWORD}" --non-interactive
          pwd
      - name: "üíæ Store Distribution SVN revision in a file"
        run: |
          cd dev-repo
          svn info ${VERSION} > DIST_SVN_REVISION.txt
      - name: "üì§ Upload Distribution SVN revision"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: dev-repo/DIST_SVN_REVISION.txt
      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          path: ${{ env.REPO_NAME }}
          ref: ${{ env.TAG }}
      - name: "üìù Fetch new sha for the release tag after pre-prelease commit"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ref_json=$(gh api "repos/${REPO_SLUG}/git/ref/tags/${TAG}")
          type=$(jq -r '.object.type' <<<"$ref_json")
          sha=$(jq -r '.object.sha'  <<<"$ref_json")
          if [ "$type" = "tag" ]; then
            sha=$(gh api "repos/${REPO_SLUG}/git/tags/${sha}" --jq '.object.sha')
          fi
          echo "Found sha: $sha"
          echo "SHA=${sha}" >> "$GITHUB_ENV"
      - name: "üìß Print Grails Vote Email"
        run: |
          export DIST_SVN_REVISION=$(awk '/Last Changed Rev:/ {print $4}' dev-repo/DIST_SVN_REVISION.txt)
          
          echo "::group::Grails PMC Vote Email"
          echo ""
          echo "TO:"
          echo "*************************************************"
          echo "dev@grails.apache.org"
          echo "*************************************************"
          echo ""
          echo "Subject:"
          echo "*************************************************"
          echo "[VOTE] Release ${PROJECT_NAME} ${VERSION}"
          echo "*************************************************"
          echo "Body:"
          echo "*************************************************"
          cat ${REPO_NAME}/.github/vote_templates/staged.txt | envsubst
          echo "*************************************************"
          echo "::endgroup::"
  release:
    environment: release
    name: "VOTE SUCCEEDED - Release Artifacts"
    needs: [ publish, source, upload ]
    runs-on: ubuntu-24.04
    steps:
      - name: "üìù Establish release version"
        run: echo "VERSION=${TAG#v}" >> "$GITHUB_ENV"
      - name: "üõ†Ô∏è Install tools"
        run: sudo apt-get install -y gettext-base
      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          ref: ${{ env.TAG }}
      - name: "üó≥ MANUAL - Confirm Grails PMC Vote succeeded"
        run: |
          echo "::group::Manual Confirmation"
          echo "üîé Make sure that the vote confirmation on dev@grails.apache.org completed successfully before proceeding."
          echo "::endgroup::"
      - name: "üìß MANUAL - Send Vote Result Email"
        run: |
          echo "::group::Manual Vote Result Email"
          echo ""
          echo "Send a new email or reply to the original vote email by changing the subject."
          echo ""
          echo "TO:"
          echo "*************************************************"
          echo "dev@grails.apache.org"
          echo "*************************************************"
          echo ""
          echo "Subject:"
          echo "*************************************************"
          echo "[RESULT][VOTE] ${PROJECT_NAME} ${VERSION}"
          echo "*************************************************"
          echo ""
          echo "Body:"
          echo "*************************************************"
          cat .github/vote_templates/vote_succeeded.txt | envsubst
          echo "*************************************************"
          echo "::endgroup::"
      - name: "üöÄ MANUAL - Release JAR files"
        run: |
          echo "::group::Manual Jar Promotion"
          echo "Run .github/scripts/releaseJarFiles.sh ${REPO_NAME}:${VERSION} <ASF_USER>"
          echo "::endgroup::"
      - name: "üöÄ MANUAL - Release distribution artifacts"
        run: |
          echo "::group::Manual ASF Artifact Promotion"
          echo "Run .github/scripts/releaseDistributions.sh ${TAG} ${SVN_FOLDER} <ASF_USER>"
          echo "::endgroup::"
      - name: "‚úÖ MANUAL - Update ASF Reporter"
        run: |
          echo "::group::Manual ASF Reporter Update"
          TODAY=$(date +"%Y-%m-%d")
          echo "Check email from no-reply@reporter.apache.org & update https://reporter.apache.org/addrelease.html?${SVN_PROJECT} to add ${SVN_FOLDER^^}-${VERSION} as complete as of ${TODAY}"
          echo "::endgroup::"
  docs:
    environment: docs
    name: "VOTE SUCCEEDED - Publish Documentation"
    needs: [ publish, source, upload, release ]
    runs-on: ubuntu-24.04
    permissions:
      contents: write # required gh-pages update
    steps:
      - name: "üìù Establish release version"
        run: echo "VERSION=${TAG#v}" >> "$GITHUB_ENV"
      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          ref: ${{ env.TAG }}
          token: ${{ secrets.GITHUB_TOKEN }} # This should not be needed as ${{ github.token }} is the default, but there have been issues with it.
      - name: "üìÖ Ensure Common Build Date" # to ensure a reproducible build
        run: echo "SOURCE_DATE_EPOCH=$(git log -1 --pretty=%ct)" >> "$GITHUB_ENV"
      - name: "‚òïÔ∏è Setup JDK"
        uses: actions/setup-java@v5
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
      - name: "üêò Setup Gradle"
        uses: gradle/actions/setup-gradle@v5
        with:
          develocity-access-key: ${{ secrets.GRAILS_DEVELOCITY_ACCESS_KEY }}
      - name: "üìñ Generate Documentation"
        run: ./gradlew grails-publish:groovydoc
      - name: "üöÄ Publish to GitHub Pages"
        uses: apache/grails-github-actions/deploy-github-pages@asf
        env:
          GRADLE_PUBLISH_RELEASE: 'true'
          SOURCE_FOLDER: plugin/build/docs/api
  close:
    name: "VOTE SUCCEEDED - Close Release"
    environment: release
    needs: [ publish, source, upload, docs, release ]
    runs-on: ubuntu-24.04
    permissions:
      contents: write # required for gradle.properties revert
      issues: write # required for milestone closing
      pull-requests: write # to open PR
      actions: write # in case there are pending changes to release.yml in the target branch
    steps:
      - name: "üìù Establish release version"
        run: echo "VERSION=${TAG#v}" >> "$GITHUB_ENV"
      - name: "üõ†Ô∏è Install tools"
        run: sudo apt-get install -y gettext-base
      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          ref: ${{ env.TAG }}
          token: ${{ secrets.GITHUB_TOKEN }} # This should not be needed as ${{ github.token }} is the default, but there have been issues with it.
      - name: "‚öôÔ∏è Run post-release"
        uses: apache/grails-github-actions/post-release@asf
      - name: "üåé MANUAL - Create Blog Post"
        run: |
          echo "::group::Blog Post Creation - MANUAL"
          echo "Publish a blog post on https://grails.apache.org/blog/ about the new release [${VERSION}] using the repo https://github.com/apache/grails-static-website"
          echo "::endgroup::"
      - name: "üåé MANUAL - Merge Close Release PR"
        run: |
          echo "::group::Merge Close Release PR - MANUAL"
          echo "The post-release step in the release workflow will create a merge branch for the original tag with version number and then open a PR to merge back into the next branch."
          echo "You will need to merge this PR into the branch after correcting any merge conflict."
          echo "::endgroup::"
      - name: "üåé MANUAL - Update Version on Grails Website"
        run: |
          echo "::group::Update Version on Grails Website"
          echo "Update the released version [${VERSION}] on the Grails Website"
          echo "https://github.com/apache/grails-static-website/blob/master/buildSrc/src/main/groovy/org/grails/documentation/DownloadPage.groovy#L43"
          echo "::endgroup::"
      - name: 'üìß Announcement Email'
        run: |
          echo "::group::Announcement Email"
          echo ""
          echo "TO:"
          echo "*************************************************"
          echo "announce@apache.org, dev@grails.apache.org, users@grails.apache.org"
          echo "*************************************************"
          echo ""
          echo "Subject:"
          echo "*************************************************"
          echo "[ANNOUNCE] ${PROJECT_NAME} ${VERSION}"
          echo "*************************************************"
          echo ""
          echo "Body:"
          echo "*************************************************"
          cat .github/vote_templates/announce.txt | envsubst
          echo "*************************************************"
          echo "::endgroup::"
